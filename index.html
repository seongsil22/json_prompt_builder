<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ JSON ì˜ìƒ í”„ë¡¬í”„íŠ¸ ë¹Œë”01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS ë³€ìˆ˜ ì„¤ì • */
        :root {
            --background-color: #ffffff;
            --text-color: #1f2937;
            --text-color-secondary: #4b5563;
            --card-background: #ffffff;
            --panel-background: #f3f4f6;
            --border-color: #d1d5db;
            --accent-color: #4f46e5;
            --accent-color-hover: #4338ca;
            --error-color: #ef4444;
        }

        .dark:root {
            --background-color: #111827;
            --text-color: #f9fafb;
            --text-color-secondary: #9ca3af;
            --card-background: #1f2937;
            --panel-background: #374151;
            --border-color: #4b5563;
            --accent-color: #6366f1;
            --accent-color-hover: #4f46e5;
        }
        
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: var(--background-color); 
            color: var(--text-color); 
            font-size: 14px; 
        }
        .card { 
            background-color: var(--card-background); 
            border: 1px solid var(--border-color); 
        }
        .input-field, select, textarea { 
            width: 100%; 
            padding: 0.5rem; 
            border-radius: 0.375rem; 
            border: 1px solid var(--border-color); 
            background-color: var(--panel-background, #f3f4f6); 
            color: var(--text-color); 
            margin-top: 0.25rem; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color-hover);
        }
        .dark .input-field, .dark select, .dark textarea { 
            background-color: #2a2a3e; /* ì–´ë‘ìš´ ì…ë ¥ í•„ë“œ ë°°ê²½ */
            border-color: #4b5563;
        }
        .btn { 
            padding: 0.5rem 1rem; 
            border-radius: 0.375rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: background-color 0.2s, opacity 0.2s; 
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary { 
            background-color: var(--accent-color); 
            color: white; 
        } 
        .btn-primary:hover:not(:disabled) { 
            background-color: var(--accent-color-hover); 
        }
        .btn-secondary { 
            background-color: var(--panel-background, #e5e7eb); 
            border: 1px solid var(--border-color); 
            color: var(--text-color-secondary); 
        } 
        .dark .btn-secondary { 
            background-color: #374151; /* ì–´ë‘ìš´ 2ì°¨ ë²„íŠ¼ */
            border-color: #4b5563;
        } 
        .btn-secondary:hover:not(:disabled) { 
            background-color: var(--border-color); 
            color: var(--text-color); 
        }
        .btn-danger { 
            background-color: #ef4444; 
            color: white; 
        } 
        .btn-danger:hover:not(:disabled) { 
            background-color: #dc2626; 
        }
        
        /* Details (ì ‘ê¸°/í´ê¸°) */
        details summary { 
            cursor: pointer; 
            font-weight: 600; 
            list-style: none; 
        } 
        details summary::-webkit-details-marker { 
            display: none; 
        }
        details summary span.arrow { 
            transition: transform 0.2s; 
            display: inline-block; 
            margin-right: 0.25rem;
            transform: rotate(0deg); /* ê¸°ë³¸ ë‹«íŒ ìƒíƒœ */
        } 
        details[open] summary span.arrow { 
            transform: rotate(90deg); /* ì—´ë¦° ìƒíƒœ */
        }
        
        label { 
            margin-bottom: 0.25rem; 
            display: block; 
            font-weight: 500; 
            color: var(--text-color-secondary);
        }
        .description { 
            font-size: 0.8rem; 
            color: var(--text-color-secondary); 
            margin-bottom: 0.5rem; 
            margin-top: -0.1rem;
        }
        
        /* ë™ì  ì•„ì´í…œ (íƒ€ì„ë¼ì¸ ë“±) */
        .timeline-segment, .rule-item, .negative-item { 
            border: 1px solid var(--border-color); 
            padding: 1rem; 
            margin-bottom: 1rem; 
            border-radius: 0.375rem; 
            position: relative;
            background-color: rgba(0,0,0,0.02); /* ì‚´ì§ ë°°ê²½ êµ¬ë¶„ */
        }
        .dark .timeline-segment, .dark .rule-item, .dark .negative-item {
            background-color: rgba(255,255,255,0.03);
        }
        .remove-btn { 
            position: absolute; 
            top: 0.5rem; 
            right: 0.5rem; 
            padding: 0.1rem 0.3rem; 
            font-size: 0.7rem; 
        }
        
        .hidden { display: none; }
        
        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message { 
            color: var(--error-color); 
            background-color: rgba(255, 85, 85, 0.1); 
            border: 1px solid var(--error-color); 
            padding: 1rem; 
            border-radius: 6px; 
            text-align: center; 
        }
        
        /* ë†’ì´ ì¼ê´€ì„± */
        select.input-field, input.input-field { 
            height: 38px; 
        } 
        .h-10 { height: 2.5rem; } /* 40px */
        .input-sm {
            height: 34px;
            font-size: 0.875rem;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        /* ë‹¤í¬ëª¨ë“œ ëŒ€ì‘ (OS ì„¤ì •) */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: var(--background-color);
            }
            .card {
                background-color: var(--card-background);
                border-color: var(--border-color);
            }
            .input-field, select, textarea {
                background-color: #2a2a3e;
                border-color: #4b5563;
                color: var(--text-color);
            }
            .btn-secondary {
                background-color: #374151;
                border-color: #4b5563;
                color: var(--text-color);
            }
            .btn-secondary:hover:not(:disabled) {
                background-color: #4b5563;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 sm:p-8 space-y-6 card">
        <header class="text-center mb-6">
              <h1 class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">ğŸ¬ JSON ì˜ìƒ í”„ë¡¬í”„íŠ¸ ë¹Œë”</h1>
              <p class="text-gray-600 dark:text-gray-400 mt-2">ìƒì„¸í•œ ì˜ìƒ ì œì‘ ê³„íšì„ JSON í˜•ì‹ìœ¼ë¡œ ì‰½ê²Œ êµ¬ì„±í•˜ê³  ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° í•˜ì„¸ìš”.</p>
        </header>

        <!-- ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° ì„¹ì…˜ -->
        <section class="border-b dark:border-gray-700 pb-6 mb-6">
              <h2 class="text-lg font-semibold mb-3">ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸°</h2>
              <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1.5fr] gap-4 items-end">
                    <div>
                        <label for="save-name">ì €ì¥ ì´ë¦„:</label>
                        <input type="text" id="save-name" class="input-field" placeholder="ì €ì¥í•  ì´ë¦„ ì…ë ¥...">
                    </div>
                    <button type="button" id="save-btn" class="btn btn-secondary h-10">í˜„ì¬ ë‚´ìš© ì €ì¥</button>
                    <div class="flex items-end gap-2">
                        <div class="flex-grow">
                            <label for="load-select">ë¶ˆëŸ¬ì˜¬ ëª©ë¡:</label>
                            <select id="load-select" class="input-field h-10"></select>
                        </div>
                        <button type="button" id="load-btn" class="btn btn-secondary h-10 px-3">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button type="button" id="delete-btn" class="btn btn-danger h-10 px-3">ì‚­ì œ</button>
                    </div>
              </div>
        </section>

        <!-- í”„ë¡¬í”„íŠ¸ í¼ -->
        <form id="prompt-form" class="space-y-6">
            
            <!-- Shot (ì´¬ì˜ ì •ë³´) -->
            <details open>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Shot (ì´¬ì˜ ì •ë³´)</span></summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div data-field="shot-composition">
                        <label for="shot-composition-select">Composition (êµ¬ë„):</label>
                        <p class="description">ì˜ìƒ ì „ì²´ ë˜ëŠ” íŠ¹ì • ì‹œê°„ëŒ€ì˜ ê¸°ë³¸ì ì¸ ì¹´ë©”ë¼ í”„ë ˆì„ êµ¬ì„±ì„ ì„¤ëª…í•©ë‹ˆë‹¤.</p>
                        <select id="shot-composition-select" class="input-field"></select>
                        <input type="text" id="shot-composition-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                    </div>
                    <div data-field="shot-lens">
                        <label for="shot-lens-select">Lens (ë Œì¦ˆ/ì´¬ì˜ ë°©ì‹):</label>
                        <p class="description">ì‚¬ìš©í•  ë Œì¦ˆ ì¢…ë¥˜ë‚˜ ì´ˆì  ê±°ë¦¬, ì´¬ì˜ ë°©ì‹ì„ ì§€ì •í•©ë‹ˆë‹¤.</p>
                        <select id="shot-lens-select" class="input-field"></select>
                        <input type="text" id="shot-lens-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                    </div>
                    <div data-field="shot-frame_rate">
                        <label for="shot-frame_rate-select">Frame Rate (í”„ë ˆì„ ì†ë„):</label>
                        <p class="description">ì˜ìƒì˜ ì´ˆë‹¹ í”„ë ˆì„ ìˆ˜(fps)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                        <select id="shot-frame_rate-select" class="input-field"></select>
                        <input type="text" id="shot-frame_rate-input" class="input-field hidden mt-1" value="30fps">
                    </div>
                    <div data-field="shot-camera_movement">
                        <label for="shot-camera_movement-select">Camera Movement (ì¹´ë©”ë¼ ì›€ì§ì„):</label>
                        <p class="description">ì¹´ë©”ë¼ê°€ ì–´ë–»ê²Œ ì›€ì§ì´ëŠ”ì§€ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤ (í•¸ë“œí—¬ë“œ, íŠ¸ë˜í‚¹ ë“±).</p>
                        <select id="shot-camera_movement-select" class="input-field"></select>
                        <textarea id="shot-camera_movement-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥..."></textarea>
                    </div>
                </div>
            </details>

            <!-- Subject (ì£¼ìš” ëŒ€ìƒ) -->
            <details open>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Subject (ì£¼ìš” ëŒ€ìƒ)</span></summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div class="md:col-span-2 grid grid-cols-2 gap-4">
                        <div><label for="subject-char1-name">ì¸ë¬¼ 1 ëª…ì¹­:</label><input type="text" id="subject-char1-name" class="input-field" placeholder="ì˜ˆ: í• ë¨¸ë‹ˆ"></div>
                        <div><label for="subject-char2-name">ì¸ë¬¼ 2 ëª…ì¹­:</label><input type="text" id="subject-char2-name" class="input-field" placeholder="ì˜ˆ: ë‚¨ì"></div>
                        <div><label for="subject-char3-name">ì¸ë¬¼ 3 ëª…ì¹­ (ì„ íƒ):</label><input type="text" id="subject-char3-name" class="input-field" placeholder="ì˜ˆ: ì•„ì´"></div>
                        <div><label for="subject-char4-name">ì¸ë¬¼ 4 ëª…ì¹­ (ì„ íƒ):</label><input type="text" id="subject-char4-name" class="input-field"></div>
                    </div>
                    <div class="md:col-span-2" data-field="subject-description">
                        <label for="subject-description-input">Description (ì„¤ëª…):</label>
                        <p class="description">ì˜ìƒì— ë“±ì¥í•˜ëŠ” ì¸ë¬¼, ì‚¬ë¬¼ ë“± ì£¼ìš” ëŒ€ìƒê³¼ ìƒí™©ì„ ì„¤ëª…í•©ë‹ˆë‹¤. (ìœ„ ëª…ì¹­ í¬í•¨)</p>
                        <textarea id="subject-description-input" class="input-field" placeholder="ì˜ˆ: [í• ë¨¸ë‹ˆ]ì™€ [ë‚¨ì]ê°€ ê³µì›ì—ì„œ ë‚˜ë€íˆ ì¡°ê¹…í•˜ë©°..."></textarea>
                    </div>
                    <div data-field="subject-wardrobe">
                        <label for="subject-wardrobe-select">Wardrobe (ì˜ìƒ):</label>
                        <p class="description">ëŒ€ìƒì˜ ì˜ìƒì„ ì§€ì •í•©ë‹ˆë‹¤. (ì¸ë¬¼ë³„ ì§€ì • ê°€ëŠ¥)</p>
                        <select id="subject-wardrobe-select" class="input-field"></select>
                        <input type="text" id="subject-wardrobe-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥... ì˜ˆ: í• ë¨¸ë‹ˆëŠ” íŒŒë€ ìš´ë™ë³µ, ë‚¨ìëŠ” ë¹¨ê°„ í‹°ì…”ì¸ ">
                    </div>
                    <div data-field="subject-props">
                        <label for="subject-props-input">Props (ì†Œí’ˆ):</label>
                        <p class="description">ëŒ€ìƒì´ ì‚¬ìš©í•˜ê±°ë‚˜ ì£¼ë³€ì— ìˆëŠ” ì†Œí’ˆì„ ì§€ì •í•©ë‹ˆë‹¤.</p>
                        <input type="text" id="subject-props-input" class="input-field" placeholder="ì˜ˆ: ë¬¼ë³‘, ìŠ¤ë§ˆíŠ¸ì›Œì¹˜">
                    </div>
                    <div data-field="subject-background_elements">
                        <label for="subject-background_elements-input">Background Elements (ë°°ê²½ ìš”ì†Œ):</label>
                        <p class="description">ë°°ê²½ì— í¬í•¨ë  ë¶€ê°€ì ì¸ ìš”ì†Œë“¤ì„ ì§€ì •í•©ë‹ˆë‹¤.</p>
                        <input type="text" id="subject-background_elements-input" class="input-field" placeholder="ì˜ˆ: ë²¤ì¹˜, ê³µì› ì‹œì„¤ë¬¼, ì§€ë‚˜ê°€ëŠ” í–‰ì¸ë“¤">
                    </div>
                </div>
            </details>

            <!-- Scene (ì¥ë©´ ì •ë³´) -->
            <details open>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Scene (ì¥ë©´ ì •ë³´)</span></summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div data-field="scene-location">
                        <label for="scene-location-select">Location (ì¥ì†Œ):</label>
                        <p class="description">ì˜ìƒì´ ì´¬ì˜ë˜ëŠ” êµ¬ì²´ì ì¸ ì¥ì†Œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                        <select id="scene-location-select" class="input-field"></select>
                        <input type="text" id="scene-location-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                    </div>
                    <div data-field="scene-time_of_day">
                        <label for="scene-time_of_day-select">Time of Day (ì‹œê°„ëŒ€):</label>
                        <p class="description">ì¥ë©´ì˜ ì‹œê°„ì  ë°°ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤ (ë‚®, ë°¤, í•´ì§ˆë…˜ ë“±).</p>
                        <select id="scene-time_of_day-select" class="input-field"></select>
                        <input type="text" id="scene-time_of_day-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                    </div>
                    <div class="md:col-span-2" data-field="scene-environment">
                        <label for="scene-environment-input">Environment (í™˜ê²½ ë¶„ìœ„ê¸°):</label>
                        <p class="description">ì¥ì†Œì˜ ì „ë°˜ì ì¸ ë¶„ìœ„ê¸°ë‚˜ ìƒíƒœë¥¼ ë¬˜ì‚¬í•©ë‹ˆë‹¤.</p>
                        <textarea id="scene-environment-input" class="input-field" placeholder="ì˜ˆ: ê¹¨ë—í•˜ê³  í™œê¸°ì°¬ ê³µì›, í‘¸ë¥¸ ë…¹ì§€ì™€ ê°„ê°„íˆ ì§€ë‚˜ê°€ëŠ” ì‚¬ëŒë“¤"></textarea>
                    </div>
                </div>
            </details>

            <!-- Visual Details (ì‹œê° ë””í…Œì¼) -->
            <details>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Visual Details (ì‹œê° ë””í…Œì¼)</span></summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div data-field="visual-action">
                        <label for="visual-action-input">Action (í–‰ë™ ë¬˜ì‚¬):</label>
                        <p class="description">ëŒ€ìƒì˜ êµ¬ì²´ì ì¸ í–‰ë™ì´ë‚˜ ì›€ì§ì„ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.</p>
                        <textarea id="visual-action-input" class="input-field" placeholder="ì˜ˆ: ìì—°ìŠ¤ëŸ½ê²Œ ì¡°ê¹…í•˜ë©° ì •ë©´ ì¹´ë©”ë¼ì™€ ëŒ€í™”í•œë‹¤."></textarea>
                    </div>
                    <div data-field="visual-special_effects">
                        <label for="visual-special_effects-select">Special Effects (íŠ¹ìˆ˜ íš¨ê³¼):</label>
                        <p class="description">ì ìš©í•  ì‹œê°ì  íŠ¹ìˆ˜ íš¨ê³¼ë¥¼ ì§€ì •í•©ë‹ˆë‹¤ (ì—†ìœ¼ë©´ 'ì—†ìŒ').</p>
                        <select id="visual-special_effects-select" class="input-field"></select>
                        <input type="text" id="visual-special_effects-input" class="input-field hidden mt-1" value="none">
                    </div>
                    <div data-field="visual-hair_clothing_motion">
                        <label for="visual-hair_clothing_motion-select">Hair/Clothing Motion (ë¨¸ë¦¬ì¹´ë½/ì˜· ì›€ì§ì„):</label>
                        <p class="description">ì›€ì§ì„ì— ë”°ë¥¸ ë¨¸ë¦¬ì¹´ë½ì´ë‚˜ ì˜·ì˜ ìì—°ìŠ¤ëŸ¬ìš´ í”ë“¤ë¦¼ ì •ë„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                        <select id="visual-hair_clothing_motion-select" class="input-field"></select>
                        <input type="text" id="visual-hair_clothing_motion-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥... ì˜ˆ: ì¡°ê¹…ì— ë§ëŠ” ê°€ë²¼ìš´ ì›€ì§ì„">
                    </div>
                </div>
            </details>
            
            <!-- Cinematography (ì´¬ì˜ ê¸°ìˆ ) -->
            <details>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Cinematography (ì´¬ì˜ ê¸°ìˆ )</span></summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div data-field="cine-lighting">
                        <label for="cine-lighting-select">Lighting (ì¡°ëª…):</label>
                        <p class="description">ì¥ë©´ì˜ ì¡°ëª… ìŠ¤íƒ€ì¼ê³¼ ì¡°ê±´ì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                        <select id="cine-lighting-select" class="input-field"></select>
                        <textarea id="cine-lighting-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥..."></textarea>
                    </div>
                    <div data-field="cine-color_palette">
                        <label for="cine-color_palette-select">Color Palette (ìƒ‰ìƒ íŒ”ë ˆíŠ¸):</label>
                        <p class="description">ì˜ìƒ ì „ì²´ì˜ ì£¼ìš” ìƒ‰ìƒ í†¤ì„ ì§€ì •í•©ë‹ˆë‹¤.</p>
                        <select id="cine-color_palette-select" class="input-field"></select>
                        <input type="text" id="cine-color_palette-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                    </div>
                    <div data-field="cine-tone">
                        <label for="cine-tone-select">Tone (ë¶„ìœ„ê¸°):</label>
                        <p class="description">ì˜ìƒì˜ ì „ë°˜ì ì¸ ë¶„ìœ„ê¸°ë‚˜ ëŠë‚Œì„ ì„¤ì •í•©ë‹ˆë‹¤.</p>
                        <select id="cine-tone-select" class="input-field"></select>
                        <input type="text" id="cine-tone-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                    </div>
                    <div class="md:col-span-2 space-y-4 border rounded p-4 dark:border-gray-600">
                        <h4 class="font-medium">Audio Guidelines (ì˜¤ë””ì˜¤ ê°€ì´ë“œë¼ì¸)</h4>
                        <div data-field="audio-music_style">
                            <label for="audio-music_style-select">Music Style (ìŒì•… ìŠ¤íƒ€ì¼):</label>
                            <select id="audio-music_style-select" class="input-field"></select>
                            <input type="text" id="audio-music_style-input" class="input-field hidden mt-1" placeholder="ì§ì ‘ ì…ë ¥...">
                        </div>
                        <div data-field="audio-mix_priority">
                            <label for="audio-mix_priority-input">Mix Priority (ë¯¹ìŠ¤ ìš°ì„ ìˆœìœ„):</label>
                            <input type="text" id="audio-mix_priority-input" class="input-field" value="dialogue on top, background restrained">
                        </div>
                        <div data-field="audio-lufs_target">
                            <label for="audio-lufs_target-input">LUFS Target (ìŒëŸ‰ ëª©í‘œ):</label>
                            <input type="text" id="audio-lufs_target-input" class="input-field" value="-16 to -14 LUFS (dialogue)">
                        </div>
                        <div data-field="audio-notes">
                            <label for="audio-notes-input">Notes (ì°¸ê³  ì‚¬í•­):</label>
                            <input type="text" id="audio-notes-input" class="input-field" placeholder="ì˜ˆ: ê³¼í•œ ì»´í”„ë ˆì…˜ í”¼í•˜ê¸°">
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- Timeline (íƒ€ì„ë¼ì¸) -->
            <details open>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Timeline (íƒ€ì„ë¼ì¸)</span></summary>
                <div id="timeline-container" class="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <!-- í…œí”Œë¦¿: íƒ€ì„ë¼ì¸ ì„¸ê·¸ë¨¼íŠ¸ -->
                    <template id="timeline-template">
                        <div class="timeline-segment">
                            <button type="button" class="remove-btn btn btn-danger text-xs px-1 py-0.5 rounded">X</button>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label>Time (t):</label><input type="text" data-key="t" placeholder="ì˜ˆ: 0-3s" class="input-field"></div>
                                <div class="md:col-span-2">
                                    <label>Description:</label>
                                    <p class="description text-xs">ì¥ë©´ ë¬˜ì‚¬ (íŒ: ëˆ„ê°€ í–‰ë™/ë§í•˜ëŠ”ì§€ ëª…ì‹œ)</p>
                                    <textarea data-key="description" placeholder="ì˜ˆ: ì •ë©´ íˆ¬ìƒ· ìœ ì§€. ë‚¨ìê°€ ëŒ€ì‚¬ë¥¼ ë§í•œë‹¤." class="input-field"></textarea>
                                </div>
                                <div class="space-y-2 border rounded p-3 dark:border-gray-600">
                                    <h5 class="font-medium text-sm">Audio</h5>
                                    <div><label class="text-xs">Music:</label><input type="text" data-key="audio.music" placeholder="ì˜ˆ: ê²½ì¾Œí•œ ì—°ì£¼ê³¡..." class="input-field input-sm"></div>
                                    <div><label class="text-xs">Ambient:</label><input type="text" data-key="audio.ambient" placeholder="ì˜ˆ: ìƒˆì†Œë¦¬, ë°”ëŒ..." class="input-field input-sm"></div>
                                    <div><label class="text-xs">Sound Effects:</label><input type="text" data-key="audio.sound_effects" placeholder="ì˜ˆ: ë°œìêµ­ ì†Œë¦¬..." class="input-field input-sm"></div>
                                    <div><label class="text-xs">Mix Level:</label><input type="text" data-key="audio.mix_level" placeholder="ì˜ˆ: ëŒ€í™” ìš°ì„ ..." class="input-field input-sm"></div>
                                </div>
                                <div class="space-y-2 border rounded p-3 dark:border-gray-600">
                                    <h5 class="font-medium text-sm">Dialogue</h5>
                                    <div><label class="text-xs">Character (í™”ì):</label><select data-key="dialogue.character" class="input-field input-sm timeline-character-select"><option value="">ì„ íƒ...</option></select></div>
                                    <div><label class="text-xs">Line (ëŒ€ì‚¬):</label><input type="text" data-key="dialogue.line" placeholder="ì˜ˆ: í• ë¨¸ë‹ˆ ì•ˆ í˜ë“¤ì–´ìš”?" class="input-field input-sm"></div>
                                    <div><label class="text-xs">Subtitles (ìë§‰ ìœ ë¬´):</label><select data-key="dialogue.subtitles" class="input-field input-sm"><option value="false" selected>ì•„ë‹ˆì˜¤</option><option value="true">ì˜ˆ</option></select></div>
                                    <div><label class="text-xs">Guideline (ê°€ì´ë“œë¼ì¸):</label><input type="text" data-key="dialogue.guideline" value="í•œêµ­ë§ë¡œ ë§í•œë‹¤" class="input-field input-sm"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                    <!-- íƒ€ì„ë¼ì¸ ì„¸ê·¸ë¨¼íŠ¸ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button type="button" id="add-timeline-btn" class="mt-2 btn btn-secondary py-1 px-3 rounded text-sm">+ íƒ€ì„ë¼ì¸ ì¶”ê°€</button>
            </details>
            
            <!-- Rules (ê·œì¹™) -->
            <details>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Rules (ê·œì¹™)</span></summary>
                <div id="rules-container" class="space-y-2 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <label class="flex items-center space-x-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                        <input type="checkbox" id="rule-match-dialogue" class="rounded text-indigo-600 focus:ring-indigo-500">
                        <span>ëŒ€ì‚¬ëŠ” ë°˜ë“œì‹œ ì§€ì •ëœ ìºë¦­í„°ì™€ ì¼ì¹˜í•´ì•¼ í•¨</span>
                    </label>
                    <!-- í…œí”Œë¦¿: ê·œì¹™ í•­ëª© -->
                    <template id="rule-template">
                        <div class="rule-item flex items-center mb-2">
                            <input type="text" data-key="rule" class="input-field flex-grow mr-2" placeholder="ì˜ˆ: ëª¨ë“  ëŒ€í™”ëŠ” ì¡°ê¹…ì„ ë©ˆì¶”ì§€ ì•Šê³  ì§„í–‰">
                            <button type="button" class="remove-btn btn btn-danger text-xs px-2 py-1 rounded" style="position: relative; top: 0; right: 0;">ì‚­ì œ</button>
                        </div>
                    </template>
                    <!-- ê·œì¹™ í•­ëª©ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button type="button" id="add-rule-btn" class="mt-2 btn btn-secondary py-1 px-3 rounded text-sm">+ ê·œì¹™ ì¶”ê°€</button>

            </details>
            
            <!-- Negatives (ì œì™¸ í•­ëª©) -->
            <details>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Negatives (ì œì™¸ í•­ëª©)</span></summary>
                <div id="negatives-container" class="space-y-2 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <!-- í…œí”Œë¦¿: ì œì™¸ í•­ëª© -->
                    <template id="negative-template">
                        <div class="negative-item flex items-center mb-2">
                            <input type="text" data-key="negative" class="input-field flex-grow mr-2" placeholder="ì˜ˆ: ê³¼ì¥ëœ ì—°ê¸°ë‚˜ ìˆ¨ì†Œë¦¬">
                            <button type="button" class="remove-btn btn btn-danger text-xs px-2 py-1 rounded" style="position: relative; top: 0; right: 0;">ì‚­ì œ</button>
                        </div>
                    </template>
                    <!-- ì œì™¸ í•­ëª©ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                <button type="button" id="add-negative-btn" class="mt-2 btn btn-secondary py-1 px-3 rounded text-sm">+ ì œì™¸ í•­ëª© ì¶”ê°€</button>
            </details>
            
            <!-- Optional (ì„ íƒ ì‚¬í•­) -->
            <details>
                <summary class="text-xl mb-2 flex justify-between items-center"><span><span class="arrow">â–¶</span> Optional (ì„ íƒ ì‚¬í•­)</span></summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div>
                        <label for="optional-safety">Safety Notes (ì•ˆì „ ì°¸ê³ ):</label>
                        <p class="description">ì´¬ì˜ ì‹œ ì•ˆì „ ê´€ë ¨ ìœ ì˜ì‚¬í•­ì„ ê¸°ì…í•©ë‹ˆë‹¤.</p>
                        <textarea id="optional-safety" class="input-field" placeholder="ì˜ˆ: ë’¤ë¡œ ê±·ëŠ” ì´¬ì˜ìë¥¼ ìœ„í•œ ë³´ì¡° ì¸ì› ë°°ì¹˜"></textarea>
                    </div>
                    <div>
                        <label for="optional-contingency">Contingency Notes (ë¹„ìƒ ê³„íš):</label>
                        <p class="description">ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™© ë°œìƒ ì‹œ ëŒ€ì²˜ ë°©ì•ˆì„ ê¸°ì…í•©ë‹ˆë‹¤.</p>
                        <textarea id="optional-contingency" class="input-field" placeholder="ì˜ˆ: í–‡ë¹›ì´ ë„ˆë¬´ ê°•í•˜ë©´ ê·¸ëŠ˜ë¡œ ì´ë™..."></textarea>
                    </div>
                </div>
            </details>

            <!-- JSON ìƒì„± ë²„íŠ¼ -->
            <button type="button" id="generate-json-btn" class="w-full btn btn-primary font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center space-x-2">
                ğŸ“„
                <span>JSON í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ê¸°</span>
            </button>

            <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
            <div id="result-container" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-semibold">ğŸ‰ JSON í”„ë¡¬í”„íŠ¸</h2>
                    <button type="button" id="copy-json-btn" class="btn btn-secondary py-2 px-4 rounded-lg">ë³µì‚¬í•˜ê¸°</button>
                </div>
                <pre class="w-full p-4 bg-gray-100 dark:bg-gray-900 rounded-lg whitespace-pre-wrap text-sm break-words border dark:border-gray-600"><code id="result-json"></code></pre>
            </div>
            
            <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="error-message" class="error-message hidden mt-4"></div>

        </form>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md card">
            <h3 id="modal-title" class="text-lg font-bold mb-4">ì•Œë¦¼</h3>
            <p id="modal-message" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-confirm-btn" class="btn btn-primary">í™•ì¸</button>
                <button id="modal-cancel-btn" class="btn btn-secondary">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const D = document;
            const form = D.getElementById('prompt-form');
            const resultContainer = D.getElementById('result-container');
            const resultJson = D.getElementById('result-json');
            const copyJsonBtn = D.getElementById('copy-json-btn');
            const errorMessage = D.getElementById('error-message');
            const STORAGE_PREFIX = 'jsonPromptBuilder_';

            const characterNameInputs = [
                D.getElementById('subject-char1-name'),
                D.getElementById('subject-char2-name'),
                D.getElementById('subject-char3-name'),
                D.getElementById('subject-char4-name')
            ];

            const examples = {
                'shot-composition': ['ì‹±ê¸€ í”„ë ˆì„ - ì „ë©´ íˆ¬ìƒ·', 'í´ë¡œì¦ˆì—…', 'ì™€ì´ë“œ ìƒ·', 'ë¯¸ë””ì—„ ìƒ·', 'ì˜¤ë²„ë”ìˆ„ë” ìƒ·', 'POV (1ì¸ì¹­ ì‹œì )'],
                'shot-lens': ['24-35mm ì „ë©´ íˆ¬ìƒ· (í•¸ë“œí—¬ë“œ)', '50mm ê³ ì •ìƒ·', '85mm í´ë¡œì¦ˆì—…', 'ë“œë¡  ê´‘ê°ìƒ·', 'ì–´ì•ˆ ë Œì¦ˆ ì™œê³¡', 'ë§¤í¬ë¡œ ë Œì¦ˆ ì ‘ì‚¬'],
                'shot-frame_rate': ['24fps (ì˜í™” ëŠë‚Œ)', '30fps (í‘œì¤€)', '60fps (ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„)', '120fps (ìŠ¬ë¡œìš° ëª¨ì…˜ìš©)'],
                'shot-camera_movement': ['í•¸ë“œí—¬ë“œ; ë’¤ë¡œ ê±·ê¸°', 'ê³ ì • ì‚¼ê°ëŒ€', 'ë‹¬ë¦¬ ì¤Œ (Dolly Zoom)', 'ìŠ¤í…Œë””ìº  íŠ¸ë˜í‚¹', 'í¬ë ˆì¸ ìƒ· (ìƒìŠ¹/í•˜ê°•)', '360ë„ íšŒì „'],
                'subject-wardrobe': ['ê°€ë²¼ìš´ ìš´ë™ë³µ', 'ì •ì¥', 'ìºì£¼ì–¼ ì˜ìƒ (ì²­ë°”ì§€, í‹°ì…”ì¸ )', 'ì „í†µ í•œë³µ', 'íŒíƒ€ì§€ ê°‘ì˜·', 'ë¯¸ë˜ì§€í–¥ì  ìš°ì£¼ë³µ'],
                'scene-location': ['ë„ì‹œ ê³µì› ì¡°ê¹…ë¡œ', 'ë²ˆí™”í•œ ë„ì‹¬ ê±°ë¦¬ (ë°¤)', 'ì¡°ìš©í•œ ì‹œê³¨ ë§ˆì„', 'í•´ë³€ê°€ ë…¸ì„', 'ëˆˆ ë®ì¸ ì‚° ì •ìƒ', 'ìš°ì£¼ì„  ë‚´ë¶€'],
                'scene-time_of_day': ['ì •ì˜¤, ë¶€ë“œëŸ¬ìš´ ìì—°ê´‘', 'í•´ì§ˆë…˜, í™©ê¸ˆë¹›', 'ë°¤, ë„¤ì˜¨ì‚¬ì¸', 'ìƒˆë²½, í‘¸ë¥¸ ë¹›', 'íë¦° ë‚  ì˜¤í›„', 'í­í’ìš° ì¹˜ëŠ” ë°¤'],
                'visual-special_effects': ['ì—†ìŒ', 'ìŠ¬ë¡œìš° ëª¨ì…˜', 'ë Œì¦ˆ í”Œë ˆì–´', 'ìƒ‰ ë³´ì • ê°•ì¡° (ì±„ë„ ë†’ì„)', 'ì•ˆê°œ íš¨ê³¼', 'ê¸€ë¦¬ì¹˜ (Glitch) íš¨ê³¼', 'íƒ€ì„ ë©ìŠ¤'],
                'visual-hair_clothing_motion': ['ì›€ì§ì„ ì—†ìŒ', 'ì¡°ê¹…ì— ë§ëŠ” ê°€ë²¼ìš´ ì›€ì§ì„', 'ë°”ëŒì— ê°•í•˜ê²Œ íœ˜ë‚ ë¦¼', 'ë¬¼ ì†ì—ì„œì˜ ì›€ì§ì„'],
                'cine-lighting': ['ë¶€ë“œëŸ¬ìš´ ìì—°ê´‘ (í™•ì‚°ê´‘)', 'ê°•í•œ ì½˜íŠ¸ë¼ìŠ¤íŠ¸ ì¡°ëª… (í•˜ë“œ ë¼ì´íŠ¸)', 'ìŠ¤íŠœë””ì˜¤ 3ì  ì¡°ëª…', 'ì‹¤ë£¨ì—£ ì—­ê´‘', 'ë„¤ì˜¨ ì¡°ëª…', 'ì´›ë¶ˆ ì¡°ëª…'],
                'cine-color_palette': ['ìì—°ìŠ¤ëŸ¬ìš´ ë…¹ìƒ‰/í•˜ëŠ˜ìƒ‰', 'ë”°ëœ»í•œ ì˜¤ë Œì§€/ë¸Œë¼ìš´ í†¤', 'ì°¨ê°€ìš´ ë¸”ë£¨/ê·¸ë ˆì´ í†¤', 'ê°•ë ¬í•œ ì›ìƒ‰ ëŒ€ë¹„', 'íŒŒìŠ¤í…” í†¤', 'ëª¨ë…¸í¬ë¡¬ (í‘ë°±)'],
                'cine-tone': ['ë”°ëœ»í•˜ê³  ì½”ë¯¹í•¨', 'ì§„ì§€í•˜ê³  ê·¹ì ì„', 'ì‹ ë¹„ë¡­ê³  ëª½í™˜ì ', 'ì°¨ë¶„í•˜ê³  ë‹¤íë©˜í„°ë¦¬', 'ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ìŠ¤ë¦´ëŸ¬', 'ë°ê³  í¬ë§ì°¸'],
                'audio-music_style': ['ê²½ì¾Œí•œ ì—…í…œí¬ ì—°ì£¼ê³¡', 'ì”ì”í•œ í”¼ì•„ë…¸ ë°°ê²½ìŒ', 'ê¸´ì¥ê° ìˆëŠ” ì˜¤ì¼€ìŠ¤íŠ¸ë¼', 'EDM ë¹„íŠ¸', 'ë¡œíŒŒì´ í™í•©', 'í´ë˜ì‹ ìŒì•…']
            };


            // --- Custom Modal Logic ---
            const modal = D.getElementById('modal');
            const modalTitle = D.getElementById('modal-title');
            const modalMessage = D.getElementById('modal-message');
            const modalConfirmBtn = D.getElementById('modal-confirm-btn');
            const modalCancelBtn = D.getElementById('modal-cancel-btn');
            let confirmCallback = null;

            function showModal(title, message, type = 'alert', callback = null) {
                if (!modal) return;
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmCallback = callback;
                
                if (type === 'confirm') {
                    modalConfirmBtn.textContent = 'í™•ì¸';
                    modalCancelBtn.classList.remove('hidden');
                } else { // 'alert'
                    modalConfirmBtn.textContent = 'í™•ì¸';
                    modalCancelBtn.classList.add('hidden');
                }
                modal.classList.remove('hidden');
            }

            function hideModal() {
                if (!modal) return;
                modal.classList.add('hidden');
                confirmCallback = null;
            }

            modalConfirmBtn?.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(true); // User confirmed
                }
                hideModal();
            });

            modalCancelBtn?.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback(false); // User cancelled
                }
                hideModal();
            });
            // --- End Custom Modal Logic ---


            // --- í•¨ìˆ˜ ì •ì˜ ---

            function createSelectWithOptions(fieldId, options) {
                const select = D.getElementById(`${fieldId}-select`);
                if (!select) return;
                select.innerHTML = ''; 

                const defaultOption = D.createElement('option');
                defaultOption.value = ""; defaultOption.textContent = "ì„ íƒ ì•ˆ í•¨";
                select.appendChild(defaultOption);

                if (options && Array.isArray(options)) {
                    options.forEach(opt => {
                        if (opt === null || opt === undefined) return; 
                        const optionEl = D.createElement('option');
                        optionEl.value = opt; optionEl.textContent = opt;
                        select.appendChild(optionEl);
                    });
                }

                const directInputOpt = D.createElement('option');
                directInputOpt.value = 'direct_input'; directInputOpt.textContent = 'ì§ì ‘ ì…ë ¥';
                select.appendChild(directInputOpt);

                const input = D.getElementById(`${fieldId}-input`);
                if (input) {
                    const listenerKey = `__${fieldId}_listener`;
                    if (!select[listenerKey]) { 
                        const handler = (event) => handleSelectChange(event, fieldId);
                        select.addEventListener('change', handler);
                        select[listenerKey] = handler; 
                    }
                    input.classList.toggle('hidden', select.value !== 'direct_input'); 
                } else if (select.value === 'direct_input') {
                    select.value = ""; 
                }
            }
            
            function handleSelectChange(event, fieldId) {
                 const select = event.target;
                 const input = D.getElementById(`${fieldId}-input`);
                 if (input) {
                     input.classList.toggle('hidden', select.value !== 'direct_input');
                     if (select.value === 'direct_input') input.focus();
                 }
            }

            // â­ï¸â­ï¸â­ï¸ [ë²„ê·¸ ìˆ˜ì •] 
            // 'ë¶ˆëŸ¬ì˜¤ê¸°' ì‹œ íƒ€ì„ë¼ì¸ì˜ í™”ì ì´ë¦„ì´ 'Subject' ëª©ë¡ì— ì—†ì–´ë„
            // ë“œë¡­ë‹¤ìš´ì—ì„œ ì‚¬ë¼ì§€ì§€ ì•Šë„ë¡ ìˆ˜ì •
            function updateTimelineCharacterOptions() {
                const characterNames = characterNameInputs
                    .map(input => input ? input.value.trim() : '') 
                    .filter(name => name); 
                
                D.querySelectorAll('.timeline-character-select').forEach(select => {
                    if (!select) return; 
                    const currentValue = select.value; // (ì˜ˆ: "í‘ì¸ ë‚¨ì")
                    select.innerHTML = '<option value="">ì„ íƒ...</option>';
                    
                    // í˜„ì¬ 'Subject' ëª©ë¡ì˜ ì´ë¦„ë“¤ë¡œ Setì„ ë§Œë“­ë‹ˆë‹¤.
                    const allNames = new Set(characterNames);
                    
                    // â­ï¸ [FIX] ë§Œì•½ í˜„ì¬ ë“œë¡­ë‹¤ìš´ì˜ ê°’(currentValue)ì´
                    // 'Subject' ëª©ë¡(allNames)ì— ì—†ë‹¤ë©´, (ì˜ˆ: ë¶ˆëŸ¬ì˜¤ê¸° ì§í›„)
                    // ì´ ê°’ì„ ì˜µì…˜ ëª©ë¡(allNames)ì— ê°•ì œë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
                    if (currentValue && !allNames.has(currentValue)) {
                        allNames.add(currentValue);
                    }

                    // ì´ì œ 'Subject' ëª©ë¡ + ë¶ˆëŸ¬ì˜¨ ê°’ì„ í¬í•¨í•œ ì „ì²´ ëª©ë¡ìœ¼ë¡œ ì˜µì…˜ì„ ë§Œë“­ë‹ˆë‹¤.
                    allNames.forEach(name => {
                        const option = D.createElement('option');
                        option.value = name; option.textContent = name;
                        select.appendChild(option);
                    });

                    // â­ï¸ ì´ì œ allNamesì— currentValueê°€ ë°˜ë“œì‹œ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ,
                    // ê°’ì„ ì•ˆì „í•˜ê²Œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    if (currentValue) {
                        select.value = currentValue;
                    }
                });
            }
            characterNameInputs.forEach(input => input?.addEventListener('input', updateTimelineCharacterOptions));


            function addTimelineSegment(segmentData = null) {
                const template = D.getElementById('timeline-template');
                if (!template || !(template instanceof HTMLTemplateElement) || !template.content) return;
                try {
                    const clone = D.importNode(template.content, true);
                    
                    if (segmentData && typeof segmentData === 'object') {
                        clone.querySelectorAll('[data-key]').forEach(input => {
                            const keys = input.dataset.key.split('.');
                            let currentData = segmentData;
                            let valueToSet = '';
                            for (let i = 0; i < keys.length; i++) {
                                const key = keys[i];
                                if (currentData && typeof currentData === 'object' && currentData.hasOwnProperty(key)) {
                                    if (i === keys.length - 1) {
                                        valueToSet = (typeof currentData[key] === 'boolean') ? String(currentData[key]) : currentData[key] || '';
                                    } else {
                                        currentData = currentData[key];
                                    }
                                } else {
                                    currentData = undefined; break; 
                                }
                            }
                            input.value = valueToSet;
                        });
                    }
                    
                    const timelineContainer = D.getElementById('timeline-container');
                    if (!timelineContainer) return;

                    const childCount = timelineContainer.children.length;
                    timelineContainer.appendChild(clone); 
                    
                    const addedSegment = timelineContainer.children[childCount]; 
                    
                    if (addedSegment) {
                        const removeBtn = addedSegment.querySelector('.remove-btn');
                        if(removeBtn) removeBtn.addEventListener('click', () => addedSegment.remove());
                    }
                    // â­ï¸â­ï¸â­ï¸ [ì¤‘ìš”]
                    // íƒ€ì„ë¼ì¸ í•­ëª©ì´ DOMì— ì¶”ê°€ë˜ê³  *ë‚œ ë’¤* í™”ì ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                    // ì´ë ‡ê²Œ í•´ì•¼ ìœ„ì—ì„œ ìˆ˜ì •í•œ updateTimelineCharacterOptionsê°€
                    // ë°©ê¸ˆ ì„¤ì •ëœ select.value (ì˜ˆ: "í‘ì¸ ë‚¨ì")ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    updateTimelineCharacterOptions(); 
                } catch (e) { console.error("Error adding timeline segment:", e); }
            }
            
            function addListItem(containerId, templateId, itemText = '') {
                const template = D.getElementById(templateId); 
                if (!template || !(template instanceof HTMLTemplateElement) || !template.content) return;
                try {
                    const clone = D.importNode(template.content, true); 
                    
                    const input = clone.querySelector('input[data-key]'); 
                    if (input && itemText) input.value = itemText;
                    
                    const container = D.getElementById(containerId); 
                    if (!container) return;

                    const childCount = container.children.length;
                    container.appendChild(clone); 
                    
                    const newItemElement = container.children[childCount];
                    
                    if (newItemElement) {
                        const removeBtn = newItemElement.querySelector('.remove-btn');
                        if (removeBtn) newItemElement.querySelector('.remove-btn').addEventListener('click', () => newItemElement.remove());
                    }
                } catch (e) { console.error(`Error adding list item to ${containerId}:`, e); }
            }
            
            D.getElementById('add-timeline-btn')?.addEventListener('click', () => addTimelineSegment());
            D.getElementById('add-rule-btn')?.addEventListener('click', () => addListItem('rules-container', 'rule-template'));
            D.getElementById('add-negative-btn')?.addEventListener('click', () => addListItem('negatives-container', 'negative-template'));

            
            function getFieldValue(fieldIdBase) {
                const select = D.getElementById(`${fieldIdBase}-select`);
                const input = D.getElementById(`${fieldIdBase}-input`); 

                if (select) { 
                    if (select.value === 'direct_input' && input) {
                        return input.value.trim(); 
                    }
                    return select.value; 
                }
                
                if (input) { 
                    return input.value.trim();
                }

                const standaloneEl = D.getElementById(fieldIdBase);
                if (standaloneEl) {
                    return standaloneEl.value.trim();
                }
                return ""; 
            }

            D.getElementById('generate-json-btn')?.addEventListener('click', () => {
                try {
                    errorMessage.classList.add('hidden');
                    resultContainer.classList.add('hidden');

                    const prompt = {
                        shot: {
                            composition: getFieldValue('shot-composition'),
                            lens: getFieldValue('shot-lens'),
                            frame_rate: getFieldValue('shot-frame_rate'),
                            camera_movement: getFieldValue('shot-camera_movement')
                        },
                        subject: {
                            characters: [
                                { name: D.getElementById('subject-char1-name').value.trim() },
                                { name: D.getElementById('subject-char2-name').value.trim() },
                                { name: D.getElementById('subject-char3-name').value.trim() },
                                { name: D.getElementById('subject-char4-name').value.trim() }
                            ].filter(c => c.name), 
                            description: getFieldValue('subject-description-input'), 
                            wardrobe: getFieldValue('subject-wardrobe'),
                            props: getFieldValue('subject-props-input'), 
                            background_elements: getFieldValue('subject-background_elements-input') 
                        },
                        scene: {
                            location: getFieldValue('scene-location'),
                            time_of_day: getFieldValue('scene-time_of_day'),
                            environment: getFieldValue('scene-environment-input') 
                        },
                        visual_details: {
                            action: getFieldValue('visual-action-input'), 
                            special_effects: getFieldValue('visual-special_effects'),
                            hair_clothing_motion: getFieldValue('visual-hair_clothing_motion')
                        },
                        cinematography: {
                            lighting: getFieldValue('cine-lighting'),
                            color_palette: getFieldValue('cine-color_palette'),
                            tone: getFieldValue('cine-tone'),
                            audio_guidelines: {
                                music_style: getFieldValue('audio-music_style'),
                                mix_priority: getFieldValue('audio-mix_priority-input'), 
                                lufs_target: getFieldValue('audio-lufs_target-input'), 
                                notes: getFieldValue('audio-notes-input') 
                            }
                        },
                        timeline: [],
                        rules: [],
                        negatives: [],
                        optional: {
                            safety_notes: getFieldValue('optional-safety'), 
                            contingency_notes: getFieldValue('optional-contingency') 
                        }
                    };

                    // íƒ€ì„ë¼ì¸ ì±„ìš°ê¸°
                    D.querySelectorAll('#timeline-container .timeline-segment').forEach(segment => {
                        const timelineData = {};
                        segment.querySelectorAll('[data-key]').forEach(input => {
                            const keys = input.dataset.key.split('.');
                            let current = timelineData;
                            keys.forEach((key, index) => {
                                if (index === keys.length - 1) {
                                    let value = input.value.trim();
                                    if (input.tagName === 'SELECT') {
                                        if (value === 'true') value = true;
                                        else if (value === 'false') value = false;
                                    }
                                    // â­ï¸â­ï¸â­ï¸ [ìˆ˜ì •]
                                    // ê°’ì´ "" (ì˜ˆ: 'ì„ íƒ...')ì´ ì•„ë‹ ë•Œë§Œ í‚¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                                    // ë˜ëŠ”, boolean falseì¼ ë•ŒëŠ” ì¶”ê°€í•©ë‹ˆë‹¤.
                                    if(value || value === false) {
                                        current[key] = value; 
                                    }
                                } else {
                                    current[key] = current[key] || {};
                                    current = current[key];
                                }
                            });
                        });
                        if (Object.keys(timelineData).length > 0 && timelineData.t) { 
                            prompt.timeline.push(timelineData);
                        }
                    });

                    // ê·œì¹™ ì±„ìš°ê¸°
                    prompt.rules = Array.from(D.querySelectorAll('#rules-container input[data-key="rule"]'))
                                      .map(input => input.value.trim())
                                      .filter(Boolean);
                    if (D.getElementById('rule-match-dialogue').checked) {
                        prompt.rules.push("ëŒ€ì‚¬ëŠ” ë°˜ë“œì‹œ ì§€ì •ëœ ìºë¦­í„°ì™€ ì¼ì¹˜í•´ì•¼ í•¨");
                    }

                    // ì œì™¸ í•­ëª© ì±„ìš°ê¸°
                    prompt.negatives = Array.from(D.querySelectorAll('#negatives-container input[data-key="negative"]'))
                                         .map(input => input.value.trim())
                                         .filter(Boolean);

                    // ë¹ˆ ê°ì²´ë‚˜ ë°°ì—´ ì •ë¦¬ (ì½”ë“œê°€ ê¸¸ì–´ ìƒëµ, ì´ì „ê³¼ ë™ì¼)
                    Object.keys(prompt).forEach(key => {
                        const value = prompt[key];
                        if (value === null || value === "") {
                            delete prompt[key];
                        } else if (Array.isArray(value) && value.length === 0) {
                            delete prompt[key];
                        } else if (typeof value === 'object' && !Array.isArray(value)) {
                            Object.keys(value).forEach(subKey => {
                                const subValue = value[subKey];
                                if (subValue === "" || subValue === null || (Array.isArray(subValue) && subValue.length === 0)) {
                                    delete value[subKey];
                                }
                                if (typeof subValue === 'object' && !Array.isArray(subValue) && subValue !== null && Object.keys(subValue).length === 0) {
                                    delete value[subKey];
                                }
                            });
                            if (Object.keys(value).length === 0) {
                                delete prompt[key];
                            }
                        }
                    });


                    resultJson.textContent = JSON.stringify(prompt, null, 4);
                    resultContainer.classList.remove('hidden');

                } catch (err) {
                    console.error("Error generating JSON:", err);
                    errorMessage.textContent = `JSON ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`;
                    errorMessage.classList.remove('hidden');
                }
            });
            
            copyJsonBtn?.addEventListener('click', () => {
                if (!navigator.clipboard) {
                    try {
                        const textArea = D.createElement('textarea');
                        textArea.value = resultJson.textContent;
                        textArea.style.position = 'fixed'; textArea.style.opacity = '0';
D.body.appendChild(textArea);
                        textArea.select();
                        D.execCommand('copy');
                        D.body.removeChild(textArea);
                        copyJsonBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
                    } catch (err) {
                        console.error('Fallback copy failed:', err);
                        copyJsonBtn.textContent = 'ë³µì‚¬ ì‹¤íŒ¨';
                    }
                } else {
                    navigator.clipboard.writeText(resultJson.textContent).then(() => {
                        copyJsonBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
                    }, (err) => {
                        console.error('Async clipboard copy failed:', err);
                        copyJsonBtn.textContent = 'ë³µì‚¬ ì‹¤íŒ¨';
                    });
                }
                setTimeout(() => { copyJsonBtn.textContent = 'ë³µì‚¬í•˜ê¸°'; }, 2000);
            });

            // --- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°/ì‚­ì œ ë¡œì§ ---
            const saveNameInput = D.getElementById('save-name'); 
            const saveBtn = D.getElementById('save-btn'); 
            const loadSelect = D.getElementById('load-select'); 
            const loadBtn = D.getElementById('load-btn'); 
            const deleteBtn = D.getElementById('delete-btn');
            
            function populateLoadSelect() {
                if (!loadSelect) return;
                loadSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>';
                const keys = [];
                try {
                    if (localStorage && typeof localStorage.key === 'function') {
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(STORAGE_PREFIX)) keys.push(key);
                        }
                    } else console.warn("localStorage is not available.");
                } catch (e) { console.error("Could not access localStorage:", e); }
                keys.sort().forEach(key => { 
                    const name = key.substring(STORAGE_PREFIX.length); 
                    const option = D.createElement('option'); 
                    option.value = key; 
                    option.textContent = name; 
                    loadSelect.appendChild(option); 
                });
            }

            function collectFormData() {
                try {
                    const data = {};
                    // ì •ì  í•„ë“œ ìˆ˜ì§‘
                    form.querySelectorAll('input[type="text"][id]:not([data-key]), input[type="password"][id], textarea[id]:not([data-key]), select[id]:not([data-key]), input[type="checkbox"][id]:not([data-key])').forEach(el => {
                        if (el.closest('.timeline-segment, .rule-item, .negative-item')) return; 
                        const baseId = el.id.replace('-select', '').replace('-input', '');
                        const selectEl = D.getElementById(`${baseId}-select`);
                        const inputEl = D.getElementById(`${baseId}-input`);

                        if (el.tagName === 'SELECT') {
                            data[el.id] = el.value;
                            if (el.value === 'direct_input' && inputEl) { 
                                data[`${baseId}-input`] = inputEl.value.trim(); 
                            }
                        } else if (el.type === 'checkbox') {
                            data[el.id] = el.checked;
                        } else if (el.id.endsWith('-input') && selectEl && selectEl.value !== 'direct_input') {
                            // 'ì§ì ‘ ì…ë ¥' ì•„ë‹ ë•Œ input ê°’ ì €ì¥ ì•ˆ í•¨
                        } else if (el.id !== 'save-name') { 
                            data[el.id] = el.value.trim();
                        }
                    });

                    // ë™ì  í•„ë“œ ìˆ˜ì§‘
                    data.timelineSegments = Array.from(D.querySelectorAll('#timeline-container .timeline-segment')).map(segment => {
                        const segmentData = {};
                        segment.querySelectorAll('[data-key]').forEach(input => {
                            let current = segmentData; const keys = input.dataset.key.split('.');
                            keys.forEach((key, index) => {
                                if (!current) return;
                                if (index === keys.length - 1) { 
                                    let value = input.value.trim(); 
                                    if (input.tagName === 'SELECT' && (value === 'true' || value === 'false')) value = value === 'true'; 
                                    current[key] = value; 
                                }
                                else { current[key] = current[key] || {}; current = current[key]; }
                            });
                        });
                        return segmentData;
                    });
                    data.rules = Array.from(D.querySelectorAll('#rules-container input[data-key="rule"]')).map(input => input.value.trim()).filter(Boolean);
                    data.negatives = Array.from(D.querySelectorAll('#negatives-container input[data-key="negative"]')).map(input => input.value.trim()).filter(Boolean);
                    const ruleCheckbox = D.getElementById('rule-match-dialogue');
                    data.ruleMatchDialogue = ruleCheckbox ? ruleCheckbox.checked : false;

                    return data;
                } catch (error) {
                    console.error("Error collecting form data:", error);
                    showModal("ë°ì´í„° ìˆ˜ì§‘ ì˜¤ë¥˜", "ë°ì´í„° ìˆ˜ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'alert');
                    return null; 
                }
            }

            function applyFormData(data) {
                if (!data || typeof data !== 'object') { console.error("Invalid data for applyFormData:", data); return; }

                try {
                    // 1. ëª¨ë“  ì •ì  í•„ë“œ ì´ˆê¸°í™” í›„ ê°’ ì ìš©
                    form.querySelectorAll('input[type="text"][id]:not([data-key]), input[type="password"][id], textarea[id]:not([data-key]), select[id]:not([data-key]), input[type="checkbox"][id]:not([data-key])').forEach(el => {
                        if (!el.closest('.timeline-segment, .rule-item, .negative-item') && el.id !== 'save-name') {
                            // ì´ˆê¸°í™”
                            if (el.type === 'checkbox') el.checked = false; else el.value = '';
                            if (el.tagName === 'SELECT') { const inputEl = D.getElementById(el.id.replace('-select', '-input')); if (inputEl) inputEl.classList.add('hidden'); }
                            
                            // ê°’ ì ìš©
                            if (data.hasOwnProperty(el.id)) {
                                const value = data[el.id];
                                if (el.tagName === 'SELECT') {
                                    const baseId = el.id.replace('-select', '');
                                    const inputEl = D.getElementById(`${baseId}-input`);
                                    const directInputValue = data[`${baseId}-input`]; 
                                    
                                    const isDirectInput = value === 'direct_input' || (!Array.from(el.options).some(opt => opt.value === value) && value !== ""); 

                                    if (isDirectInput) {
                                        el.value = 'direct_input';
                                        if (inputEl) { 
                                            inputEl.value = directInputValue || (value !== 'direct_input' ? value : '') || ''; 
                                            inputEl.classList.remove('hidden'); 
                                        }
                                    } else if (value !== undefined && value !== null) {
                                        el.value = value;
                                        if (inputEl) inputEl.classList.add('hidden');
                                    } else { 
                                         el.value = "";
                                         if (inputEl) inputEl.classList.add('hidden');
                                    }
                                } else if (el.type === 'checkbox') {
                                    el.checked = value || false;
                                } else {
                                    el.value = value || '';
                                }
                            }
                        }
                    });

                    // 2. ë™ì  ìš”ì†Œ ì¬ìƒì„±
                    const timelineContainer = D.getElementById('timeline-container'); 
                    timelineContainer.querySelectorAll('.timeline-segment').forEach(el => el.remove()); 
                    if (data.timelineSegments && Array.isArray(data.timelineSegments) && data.timelineSegments.length > 0) { 
                        data.timelineSegments.forEach(segmentData => addTimelineSegment(segmentData)); 
                    } else { 
                        addTimelineSegment(); 
                    }

                    const rulesContainer = D.getElementById('rules-container'); 
                    rulesContainer.querySelectorAll('.rule-item').forEach(el => el.remove()); 
                    if (data.rules && Array.isArray(data.rules)) { 
                        data.rules.forEach(ruleText => {
                            if (ruleText !== "ëŒ€ì‚¬ëŠ” ë°˜ë“œì‹œ ì§€ì •ëœ ìºë¦­í„°ì™€ ì¼ì¹˜í•´ì•¼ í•¨") {
                                addListItem('rules-container', 'rule-template', ruleText);
                            }
                        });
                    }

                    const negativesContainer = D.getElementById('negatives-container'); 
                    negativesContainer.querySelectorAll('.negative-item').forEach(el => el.remove()); 
                    if (data.negatives && Array.isArray(data.negatives)) { 
                        data.negatives.forEach(negText => addListItem('negatives-container', 'negative-template', negText)); 
                    }

                    const ruleCheckbox = D.getElementById('rule-match-dialogue'); 
                    if(ruleCheckbox) ruleCheckbox.checked = data.ruleMatchDialogue || (data.rules && data.rules.includes("ëŒ€ì‚¬ëŠ” ë°˜ë“œì‹œ ì§€ì •ëœ ìºë¦­í„°ì™€ ì¼ì¹˜í•´ì•¼ í•¨")) || false;

                    // â­ï¸â­ï¸â­ï¸ [ì¤‘ìš”]
                    // addTimelineSegmentì—ì„œ ì´ë¯¸ í™”ì ëª©ë¡ì„ ê°±ì‹ í–ˆì§€ë§Œ,
                    // 'Subject' í•„ë“œê°€ ëª¨ë‘ ì ìš©ëœ *ì´í›„*ì—
                    // í•œ ë²ˆ ë” ê°±ì‹ í•˜ì—¬ ìµœì‹  ìƒíƒœë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
                    updateTimelineCharacterOptions(); 

                } catch (error) {
                    console.error("Error applying form data:", error);
                    showModal("ë°ì´í„° ì ìš© ì˜¤ë¥˜", "ë°ì´í„° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", 'alert');
                }
            }
            
            saveBtn?.addEventListener('click', () => {
                const saveName = saveNameInput.value.trim();
                if (!saveName) {
                    showModal('ì…ë ¥ ì˜¤ë¥˜', 'ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', 'alert');
                    saveNameInput.focus();
                    return;
                }
                try {
                    const data = collectFormData();
                    if (data) {
                        localStorage.setItem(STORAGE_PREFIX + saveName, JSON.stringify(data));
                        populateLoadSelect();
                        loadSelect.value = STORAGE_PREFIX + saveName; 
                        showModal('ì €ì¥ ì™„ë£Œ', `'${saveName}'(ìœ¼)ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'alert');
                    }
                } catch (e) {
                    console.error("Save failed:", e);
                    showModal('ì €ì¥ ì‹¤íŒ¨', `ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`, 'alert');
                }
            });

            loadBtn?.addEventListener('click', () => {
                const selectedKey = loadSelect.value;
                if (!selectedKey) {
                    showModal('ì„ íƒ ì˜¤ë¥˜', 'ë¶ˆëŸ¬ì˜¬ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', 'alert');
                    return;
                }
                try {
                    const dataString = localStorage.getItem(selectedKey);
                    if (dataString) {
                        const data = JSON.parse(dataString);
                        applyFormData(data);
                        saveNameInput.value = selectedKey.substring(STORAGE_PREFIX.length); 
                        showModal('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ', `'${saveNameInput.value}'(ì„)ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, 'alert');
                        resultContainer.classList.add('hidden'); 
                    }
                } catch (e) {
                    console.error("Load failed:", e);
                    showModal('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', `ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`, 'alert');
                }
            });

            deleteBtn?.addEventListener('click', () => {
                const selectedKey = loadSelect.value;
                if (!selectedKey) {
                    showModal('ì„ íƒ ì˜¤ë¥˜', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', 'alert');
                    return;
                }
                const saveName = selectedKey.substring(STORAGE_PREFIX.length);

                showModal('ì‚­ì œ í™•ì¸', `'${saveName}'(ì„)ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 'confirm', (confirmed) => {
                    if (confirmed) {
                        try {
                            localStorage.removeItem(selectedKey);
                            populateLoadSelect();
                            saveNameInput.value = ''; 
                            showModal('ì‚­ì œ ì™„ë£Œ', `'${saveName}'(ì´)ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'alert');
                        } catch (e) {
                             console.error("Delete failed:", e);
                             showModal('ì‚­ì œ ì‹¤íŒ¨', `ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`, 'alert');
                        }
                    }
                });
            });

            // --- ì´ˆê¸°í™” ---
            function initialize() {
                for (const fieldId in examples) { 
                    createSelectWithOptions(fieldId, examples[fieldId]); 
                }
                addTimelineSegment(); 
                updateTimelineCharacterOptions();
                populateLoadSelect(); 
                
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
            
            initialize(); // ì•± ì‹œì‘!

        });
    </script>
</body>
</html>

